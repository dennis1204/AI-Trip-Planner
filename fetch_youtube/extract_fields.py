from langchain_openai import AzureChatOpenAI
from langchain_core.prompts import PromptTemplate
from langchain_core.output_parsers import StrOutputParser
from openai import AzureOpenAI
import json
import re
from dotenv import load_dotenv
import os
load_dotenv()
# llm = AzureChatOpenAI(azure_deployment="gpt-4o-mini", api_version="2023-05-15")

endpoint = os.getenv("AZURE_ENDPOINT")
subscription_key = os.getenv("AZURE_API_KEY")
model_name = "gpt-5-mini"
deployment = "gpt-5-mini"
api_version = "2024-12-01-preview"

llm = AzureChatOpenAI(
    azure_deployment="gpt-5-mini",
    api_version=api_version,
    azure_endpoint=endpoint,
    api_key=subscription_key,
)

# Improved prompt for Chinese/Cantonese transcript
prompt_template = """
You are an expert at extracting restaurant recommendations from transcripts (in Chinese or English).
Extract all mentioned restaurants from this transcript. For each, output fields: 
- Name (restaurant name)
- Location (e.g., district like Tuen Mun)
- Description/Highlights (e.g., dishes like curry chicken)
- Why Recommended (e.g., local fave, cheap for students)
- Cost Estimate (e.g., HKD 50 lunch set)
- Unique Tips (e.g., add less sugar, big portions)

If no restaurants, output []. Focus on food places in Hong Kong (e.g., Tuen Mun eateries).
Output ONLY a valid JSON array of objects, no extra text.

Transcript: {transcript}
"""

prompt = PromptTemplate.from_template(prompt_template)

# Your transcript (it's about Tuen Mun restaurants like Indian curry place)
transcript = "沒有選錯 我意思是沒有選錯這家店 大角咀出名多美食 但是不熟悉這區域的人 又很少進來這個九龍中心的結界 有很多寶藏小店  就連我這個住了兩年多的新街坊都未試過 串燒十多元一份 這裡真的很街坊價 今次我遊走大角咀兩大區域 新九龍富多來 以及中匯街 大全街 去尋找屬於街坊的宵夜 由酒店 廚房出身的老闆打理 識食之人才懂得來的內街一人串燒店 每上一道菜 他就告訴我一些小秘訣 我覺得好像有種在享用廚師發辦的感覺 還有街坊當正餐進食的即叫即炸煎釀三寶 我們不是被奶粉餵大 而是被這些零食餵大 有人叫96件的？ 塞滿整個鐵鑊 盆菜版煎釀三寶 還有凌晨3時半仍未關門 最適合一大群朋友來的餃子粥麵店 最多人 我記得是 一群22個女生 這裡的氣氛適合 通常會吃甚麼 蠔仔粥 蠔仔多過米 娓娓地 美味地 今集為你道來三間大角咀深夜食堂的故事 大角咀人 一起留言分享一下 你有甚麼私心推介 話說我是大角咀的新街坊 住在這區兩年多 但是 我是一個失敗的街坊 未試過很多食物 不過我也有一些社區觀察 大角咀其實可以分為兩大區域 大全街那邊自成一區 而我身 後的富多來和新九龍就是另一區 因為兩者中間隔了一條大橋 像紅海分隔兩邊 富多來是一個很有趣的商場 因為它的業權很分散 所以就有很多小店 有懷舊感覺的相機舖 這間麵家我不敢衝破 但是很多街坊都說它的牛雜很出色 你看看門面 有種耐人尋味的感覺 然後有很多民生店 新九龍這邊的居民其實不用特意走過去對面大馬路 這一間我們都採 訪過 我來找食物 看看你有沒有甚麼介紹 介紹？首選明叔 因為他弄的串燒會有不同的汁蘸不同的串燒 怕不怕我們搶了你的飯堂 我現在要去找明叔 弄得我今天不能吃 哈囉 哈囉 是不是明哥呀 是呀 我先進去看看有甚麼吃 好 慢慢看餐牌吧 這麼小一間店有鱔 烏頭 其實已經有點意外 然後還有很多腸類和蔬菜 但我覺得比較特別的是印度烤餅 明哥還有賣手打魚肉湯 豆腐花和涼粉 串燒十多元一份 我覺得我現在外出吃串燒很少看到一字頭 至少都要二十多元起跳 所以這裡真的很街坊價 不如先聽你的意見 我一定要吃的 羊鞍 寫羊鞍 好 一份鱔 好的 再加一些豬肉 豬 印度烤餅 法包也好 謝謝 這個醬汁可以喝 值回一半 剛才他說他加了白酒 香草 還有椒鹽 所以不是普通的蒜蓉 點芥辣  好的 每上一道菜 他就告訴我一些小秘訣 我覺得好像有種在享用廚師發辦的感覺 你看看多軟嫩 燒得剛剛好 因為我說要六成熟 好像在西餐廳般可以選擇六成 我是真的驚訝 我發現一點都不硬 因為通常蒜蓉包都是硬弸弸的 通常會吃得口腔受傷 因為可能店舖又小 明哥自己一手包辦 我又覺得 自己一個人來吃很有感覺 你是不是通常自己一個人來吃的 是呀 多數都是 多數都是自己一個 這種單身寡佬 喂 不應該講的不要講 日日都來 不吃東西都在這裡閒坐 我有時候自己買些海鮮來燒 明哥我可以拿飲品嗎 ? 可以 你 慢慢 自己來嗎 自己吧 這裡是自助餐 哎 今日免費飲啦 明叔年輕時做過酒店廚師 又做過理髮 2007年在富貴大廈附近開了明廚美食 每日由荃灣跨區來到大角咀開舖 那時找 舖位最便宜的是大角咀 2007年的時候 那邊的店差不多七八千元舖租 最初賣三文治做得不好 就要去變 自此轉型做串燒 儲到一群忠實食客 2016年因為重建搬到角祥街 2018 年再搬到富多來 三次都是位於大角咀 第一間店對出的十字路口 人流真的比較多 一燒出來的味道飄開了 人們路過就會記起想吃串燒的感覺 會不會旺過現在這條街 旺很多  因為富多來通常人們走外面 有沒有客人由第一間店跟你到現在 有 現在有八成客人還是那些 以前那邊 我年輕時別人叫我鬍鬚佬 現在這邊多數人叫我明叔 你剛剛走過認得明叔嗎？ 是啊 我以前是住大角咀 現在住大埔 因為我們有一直在找 我們以前叫你串燒伯伯 那時他都說是人們晚上下班 他才出來擺檔 擺在街上 然後我們就買回家吃 最好吃 的是甚麼 其實他樣樣都好吃 牛舌 那就要多一份牛舌吧 近幾年更吸引了兩位貴賓 每晚都風雨不改去找明叔 你好 牠們有份吃的嗎 是的 正在等候 喂 妹妹 預先燒好放在這 裡 一整批的 她日日放狗走過 我都給牠們吃 小的那隻狗會偏食 大件一點就不吃 有點燒焦也不吃 大角咀街坊很嘴刁 狗都嘴刁過人 雖然種類多 又要慢慢燒 明叔對食物自有一份執著 這個烤餅有造型 而且不是平時一塊扁扁的 彷彿是一絲絲的 所以吃起來裡面還是有種煙韌的感覺 然後醬是偏甜的 五花腩 用少許磨豉醬 又有香茅味的梅頭肉 沙薑味的豬頸肉 這個豬腩肉 不得了 明哥如果我這隻肉想搭配這種味道 有嗎？ 沒有 因為每一種味道都是我自己調配好的 我不想做到像重慶燒烤般灑調味料上去 全部如果關了 燈後都吃到同一種味道 沒有甚麼秘方 只不過你自己用心去煮好 人們吃下去覺得適合口味 一個人默默經營 曾經風光一時 轉換舖位後不太如意 前兩三年都幾乎沒賺錢 兩年 疫症已經很難熬過去 現在的環境後遺症更多 只不過為了一件事 就是有熟客 還可以維持到今天 訪問到我 就叫做算了吧還可以堅持 這裡有沒有想做到甚麼時候 這裡和業主 還有一年（租約） 你有沒有想過搬離大角咀這區 那麼你做生意就方便些 不搬了 一搬就退休 要保持水準 又不容易 那批客人肯不肯來光顧你 又不容易 不拚命了 應該是要 去享受的時間 離開了富多來和新九龍的地域 我們現在經過這個大角咀道 在西九龍走廊西段的下面 穿過橋底 就會去到大角咀的另一個部份 此處就是明廚以前的位置 現時已經是一座新樓了 我覺得是大角咀的特色 尤其是這一邊的大角咀 我都看到這些店舖或者食肆的價錢越來越貴 還有我覺得大角咀有一個街坊都知道的問題 就是滴水 這個問題 我覺得在可見的將來 暫時就算有新樓都未解決得到 這裡就是 我覺得這邊的大角咀最多食肆的街道 就是埃華街 大全街 還有那邊的中匯街 這家茶餐廳本身是在港灣豪庭入面 然後搬舖 成為了街坊群組內的熱話 搬了舖 我已來光顧了 店舖變大了 所以很有趣 我覺得這件事是十分有趣的 接下來我要去試一間煎釀三寶 因為我不止一次聽過人說 大 角咀有很好吃的煎釀三寶 於是我就上網找 我找到了兩張照片 我覺得一定是這一間 因為它寫著「即叫即炸」 我就深信應該是這一間 你好你好 有沒有新客套裝 看看有甚麼 要我試 我就試 甚麼都給你試一下 大全街轉角這家小食店 開業三十多年 主打新鮮即炸三寶 有時八時許售罄就關門 吃到吃不到 有時都是靠運氣 因為你經常吃閉門羹 是 吃了五次閉門羹 數著 五次 但是經常會想過來吃嗎 簡直中了煎釀三寶毒 很彈牙 這裡的豉油很美味 一定要加甜醬食 有人叫96件的？ 有 塞滿整個鑊 嘩 這個不得了不得了 盆菜版煎釀三寶 好 我找到一個人幫我一起吃這盆煎釀三寶盆菜 見到菜單上炸燒賣一元一顆 我覺得一定要來試試 那你一個星期吃多少次啊 我估計一個星期都有五六次 即炸我覺得有個不同之處 就是它的蔬菜好像保持得比較新鮮 我覺得它的水分都保持得很好 它是保存得到 你吃得到是新鮮魷魚那種質地 而不是炸完變得脆卜卜很乾的那種 即是內 外都還是軟嫩的 我準備要考中學文憑考試 我是中六學生 有時學習壓力會很大 覺得這對我來說是一個療癒美食 一買到手是熱騰騰的 我就會拿手機出來拍 Snapchat 「要開 心」 每次都發佈「要開心」 媽媽每次看到桌上有兩袋東西 飯又做好 然後大家又不吃 那兩袋東西就是炸燒賣 ​可能媽媽都想問 背後的始作俑者是誰呢 你可以叫我大角咀 古天樂也好 東興小食古天樂也好 實不相瞞 剛才你很專心炸東西時 我有兩下覺得真的像 連同口罩 要不要先唱歌 古天樂 陳生是東興第三代老闆 由太太和媽媽幫忙打理店舖  你看這裡如此舊的裝修 就是這麼多年的歷史 第一代的師公 就是很多最老的街坊一直光顧的 對面望著君匯港這裡以前是海 第二代店主呢 第二手是他師傅 是我師傅 移民了 陳生在東興吃回童年的味道 本來是一名婚禮攝影師 疫情令工作停擺 加上小朋友出生 一直想尋找出路 之後就和老闆 即是我的師傅談起 有没有想過找一些人可以接棒 可以 繼續做下去 很快 我當晚就跟我太太談 太太 我想做這件事 你允許嗎？ 她說 你喜歡就去吧 之後我夜晚就立刻决定了走這一步 從拿相機到拿鐵鑊 最重要的是繼承調味配方 學打魚肉 好像從前武俠小說那樣 師傅收我為徒吧 即是起碼每一次 我就要攪拌二三十下 魚肉摸起來彈不彈牙 均不均勻 你做了那麼久 其實你自己感覺到 完全黏住 以我自 己的標準就為之合格 你見到打兩下都會喘氣 客人吃下去說好好吃 其實打每一下我都覺得值得 每日七斤魚肉 100至150位客人 有時9時前就賣完 你們何不做晚一點？ 這些小食不是通常越夜越有機嗎 糟糕 暴露年齡 越夜越有機 越夜越有機 甚麼來的 因為我們不會保留食物的 所以我們賣完就算了 現在日日賣清的份量 曾經令陳生懷疑人生 以前 真的賣不完的 這感覺真的挺辛苦 其實東興小食在大角咀已經很有份量 有很多壓力 因為你始終會有比較 以前是怎樣 然後自己不斷覺得很不開心 要忍住 不斷地要改善 我現在就有第二個想法 就是想更加多人認識這個香港地道小食 街坊James有沒有告訴你 他每次吃完都會拍照 沒有 看見他這麼辛苦 補完習 然後就會過來找我買東西吃 可能我都會成為一個鼓勵他的人 不過這些都是你在開店前猜不到的 意料不到的 以前在街邊吃東西 接觸的來來去去都是那幾間店 反而我更了解街坊 變成和大家共為一體 陳生不只跟街坊打成一片 就連家庭生活都離不開三寶 我大兒子是一隻狗 牠叫豆腐 我二兒子 親生大兒子 叫魚蛋 因為他的臉很像魚蛋 我的小兒子叫青椒 我已經變得熱愛煎釀三寶到這個地步 媽媽 太太 紅腸 紅腸 為甚麼 好吃呀 平時關店就是這樣 一間家庭式小店 我覺得是難以置信 我想 問大角咀街坊都會問為甚麼現在的店舖這麼早關門 喜歡夜晚的大 角咀嗎？ 當然喜歡 我還年輕的時候會經常出夜街 去大角咀碼頭那邊 都挺好氣氛 真的有點失落 不多宵夜了 一間通宵的 就叫麥當勞 但不是的 晚上9時之後都有東西吃 除 了麥記 隔一條街其實還有 耀記餃子 就經營得比較晚 我住這邊 平時夜晚一打開窗 味道都會飄上來 其實是很香的 你好 一位 入面坐 耀記扎根大角咀十多年 原先由耀哥耀 嫂兩夫婦經營雲吞麵 後來佐敦店專注做雲吞麵 耀嫂就留在大角咀做餃子 食客來自五湖四海 但最多的是叫車來的大學生 由下午3時開到凌晨3時半 都只是為了等「屋企人」 我當她們是自己的女兒 午夜12時之後才過來吃宵夜 這段時間是他們最開心吃宵夜的時間 好像自己人開飯的那種感覺 為甚麼這麼多浸會大學的同學懂得來耀記 因為這裡不近 就是有個傳統會帶我們這裡來吃宵夜 通常會吃甚麼 因為我第一次來 不知道要點甚麼 蠔仔粥 蠔仔多過米 真的跟平時的潮州蠔仔粥不同 其中一個秘密 耀嫂不肯說 但我發 現到有乾魷魚 應該是要來加重湯底的海鮮味 而且它的湯底是有種 我真的在喝煲湯的湯的感覺 所以夜晚如果你工作到很累過來吃 你會有一種暖胃補身的感覺 我們的餃子是 天天賣清的 每天早上蔬菜到店 再切再包 即整即煎 很新鮮的 姐姐都做了7年 她煎餃子比我更厲害 出面很脆 無論是皮還是餡都是偏甜的 所以就覺得好像吃零食一樣 不過可惜今天試不到韭菜餃 因為已經賣光了 吃過的朋友在下面留言 告訴我韭菜餃的味道 我們今天雖然點了粥和餃子 但還有很多其他菜 全部都比較適合一大群人過來吃 這裡的氣氛有甚麼特別適合你們說八卦 不是不是不是 我不說八卦的 輕鬆聊天 深夜情緒化的時間 分享心事又好 談談學習上的事也好 學習上的事 三好學生  今年生意是最差的一年 很多人都上去大陸 有影響的 慶幸有些年輕人來光顧我 我都挺開心的 有人來撐住我 我想我應該由小學四五年級開始吧 到現在應該有16年了 搬走了去深水埗 現在騎單車就 很方便 想吃東西 又想不到吃甚麼 都會回來這裡吃 除了吃味道 就是想回味回憶 多不多這些從小看到大的食客 很多 不過很多都搬走了 不會像以前般頻密回來 但是見到都 很開心 是潛意識 即是想吃宵夜就會回來找阿姨 我要在這裡等他們來 不是說為了做生意 但這些是我的責任 他們會來的 會遠道而來 總之我會遲不會早 你喜歡大角咀這區嗎？ 我喜歡大角咀 走來走去都是見到熟悉的人 大家都很友好 好像自己都變得很年輕 給一個愛心手勢 笑到喀喀聲 我請你們吃甜品 剛剛另一個客人請我吃的 我做得開心 他 們吃得開心 那我就開心了 拍攝到第三間餐廳 現在的時間已經是凌晨1時多了 拍攝熬夜不可憐 最麻煩的是過了凌晨 聲開始沙 還會乾咳 現在喉嚨還有點痕癢 最怕一會說對 白不暢順 幸好我已經準備了珮夫人止咳露 它有獨特草本配方可以紓緩喉嚨不適 好 可以就位 大角咀有點像一個山谷 即是一個要你特地入來去找 要去發掘的一個地方 但是 內裡可能會找到一些讓你有意外驚喜的東西 最驚喜是明哥那裡 另一個大驚喜就是姐姐和妹妹出鏡的兩次 大家都可以考慮一下 過來這個山谷偶遇一下我 看看會不會在吃宵夜的時候看到大家 在我的印象中 我覺得大角咀應該是很多宵夜店舖 夜晚還是很燈火通明 但是我這次來就發現 9時後我們去完東興之後 就很多店舖開始關燈 我覺得有點可惜 但是可惜之中我又發現 原來雖然街道很清靜 但是仍然有一些地方在亮燈 就是為了街坊下來 不要全都關燈 還有東西吃 我覺得這件事都挺感動 好想聽下 其實大家對於大角 咀還有甚麼想法 覺得大角咀的特色是怎樣呢 歡迎留言告訴我 感謝大家陪我夜遊大角咀 再見 我唯一有些少投訴 就是我覺得街市物價有點貴 對呀 不會去街市買菜 對呀 我 覺得街市的東西很貴 我一定光顧那個阿叔 買菜 對呀對呀 新冠肺炎那陣子他沒有開店 我很擔心 阿叔去了哪裡 我都住了已經兩年多 我們真的在「吹水」 街坊的水  "
# Non-chained invocation to avoid pipe error
formatted_prompt = prompt.format(transcript=transcript)
response = llm.invoke(formatted_prompt)
extracted_text = response.content.strip()

print("Raw Response from LLM:")
print(extracted_text)

# Clean and parse JSON (handle extra text like "Here is the JSON:")
# Use regex to extract JSON array
json_match = re.search(r'\[\s*{.*?}\s*\]', extracted_text, re.DOTALL)
if json_match:
    extracted_text = json_match.group(0)
    try:
        extracted = json.loads(extracted_text)
        print("Parsed JSON:", json.dumps(extracted, indent=4, ensure_ascii=False))
        # Save to file
        with open('extracted_restaurants.json', 'w', encoding='utf-8') as f:
            json.dump(extracted, f, indent=4, ensure_ascii=False)
        print("Extraction complete! Saved to extracted_restaurants.json")
    except json.JSONDecodeError as e:
        print(f"JSON Parse Error: {e}. Trying raw save.")
        with open('extracted_restaurants_raw.txt', 'w', encoding='utf-8') as f:
            f.write(extracted_text)
else:
    print("No JSON found in response. Raw output saved.")
    with open('extracted_restaurants_raw.txt', 'w', encoding='utf-8') as f:
        f.write(extracted_text)